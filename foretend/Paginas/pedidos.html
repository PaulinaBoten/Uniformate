<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi Pedido</title>
  <style>
    body { font-family: Arial; background-color: #d3eeaf; padding: 20px; }
    .producto { background: white; padding: 10px; margin: 10px; border-radius: 8px; }
    button { background: #279419; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>üõçÔ∏è Mi Pedido</h1>
  <div id="carrito"></div>
  <button id="enviarPedido">Enviar Pedido</button>
  <hr>
  <button id="verPedidos">üìã Ver mis pedidos</button>
  <div id="listaPedidos"></div>

  <script type="module">
    const carritoContainer = document.getElementById("carrito");
    const listaPedidos = document.getElementById("listaPedidos");
    const carrito = JSON.parse(sessionStorage.getItem("carrito")) || [];

    // Mostrar carrito actual
    if (carrito.length === 0) {
      carritoContainer.innerHTML = "<p>No hay productos en el carrito.</p>";
    } else {
      carritoContainer.innerHTML = carrito.map(p => `
        <div class="producto">
          <strong>${p.nombre}</strong><br>
          Cantidad: ${p.cantidad}
        </div>
      `).join("");
    }

    // Enviar pedido
    document.getElementById("enviarPedido").addEventListener("click", async () => {
      const userId = sessionStorage.getItem("userId");

      for (const producto of carrito) {
        const body = {
          usuario_id: userId,
          inventario_id: producto.id,
          cantidad: producto.cantidad
        };

        const res = await fetch("http://localhost:3000/api/pedidos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log("Pedido:", data);
      }

      alert("‚úÖ Pedido enviado correctamente");
      sessionStorage.removeItem("carrito");
      window.location.href = "prin.html";
    });

    // Ver pedidos del usuario
    document.getElementById("verPedidos").addEventListener("click", async () => {
      const userId = sessionStorage.getItem("userId");
      const res = await fetch(`http://localhost:3000/api/pedidos?usuario_id=${userId}`);
      const pedidos = await res.json();

      if (pedidos.length === 0) {
        listaPedidos.innerHTML = "<p>No tienes pedidos a√∫n.</p>";
      } else {
        listaPedidos.innerHTML = pedidos.map(p => `
          <div class="producto">
            <strong>${p.producto}</strong><br>
            Cantidad: ${p.cantidad}<br>
            Estado: ${p.estado}<br>
            Fecha: ${new Date(p.fecha).toLocaleString()}
          </div>
        `).join("");
      }
    });
  </script>
</body>
</html>
