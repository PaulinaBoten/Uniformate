<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tu Cesta de Solicitudes - Uniformes CEFA</title>
  <link rel="stylesheet" href="/foretend/Paginas/CSS/pedidos.css">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <header class="logo"> 
    <div class="Letra">
      <h1>UNIFORMATE</h1>
    </div>
    <nav class="botones">
      <a href="/foretend/Paginas/prin.html">Inicio</a>
      <a href="/foretend/Paginas/cata.html">Cat√°logo</a>
      <a href="/foretend/Paginas/comunicate.html" target="_blank">Cont√°ctanos</a>
      <a href="/foretend/Paginas/inicio.html" id="enlaceUsuarios" style="display:none;">Usuarios</a> 
      <a href="/foretend/Paginas/Admin.html" id="enlaceAdmin" style="display:none;">Administrador</a>
      <a href="#" id="cerrarSesionBtn" style="display:none;">Cerrar sesi√≥n</a>
    </nav>
  </header>

  <main class="container">
    <h1>Tu Cesta de Solicitudes</h1>

    <div class="cart-items" id="cartItems">
      <p class="empty-cart-message" id="emptyCartMessage">No hay uniformes en tu cesta de solicitudes. Agrega desde el <a href="/foretend/Paginas/cata.html">cat√°logo</a>.</p>
    </div>

    <div class="form-section">
      <h2>Confirma tus datos para la solicitud</h2>
      <form id="orderForm">
        <div class="form-group">
          <label for="fullName">Nombre Completo:</label>
          <input type="text" id="fullName" name="fullName" required readonly>
        </div>
        
        <div class="form-group">
          <label for="orderDetails">Uniformes Solicitados:</label>
          <textarea id="orderDetails" name="orderDetails" rows="5" readonly required></textarea>
        </div>
        
        <button type="submit" class="submit-button">Confirmar Solicitud</button>
      </form>
    </div>
  </main>

  <footer>
    <div class="footer-container">
      <div class="footer-box">
        <h3>üìû Contacto</h3>
        <p><i class="fas fa-phone-alt"></i> 300 4197922</p>
        <p><i class="fas fa-map-marker-alt"></i> C 50 #41-55, La Candelaria, Medell√≠n</p>
      </div>
      <div class="footer-box">
        <h3>üì≤ Redes Sociales</h3>
        <a href="https://www.instagram.com/centroformativodeantioquia/" target="_blank">
          <i class="fab fa-instagram"></i> Instagram
        </a>
        <a href="https://wa.me/qr/NLHKB7NV3GKAI1" target="_blank">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
      </div>
      <div class="footer-box">
        <h3>üéì Cr√©ditos</h3>
        <p>Paulina Botero Gonz√°lez</p>
        <p>Valeria Llano Quintero</p>
      </div>
    </div>
  </footer>

  <!-- Bot√≥n flotante de WhatsApp -->
  <a href="https://wa.me/qr/NLHKB7NV3GKAI1" class="whatsapp-float" target="_blank" aria-label="Contactar por WhatsApp">
    <img src="/foretend/Paginas/img/whatsapp-white-icon.png" alt="WhatsApp">
  </a>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const token = sessionStorage.getItem('token');
        const userRole = sessionStorage.getItem('userRole');
        const userId = sessionStorage.getItem('userId');
        const userFullName = sessionStorage.getItem('userFullName');

        const cerrarSesionBtn = document.getElementById('cerrarSesionBtn');
        const enlaceUsuarios = document.getElementById('enlaceUsuarios');
        const enlaceAdmin = document.getElementById('enlaceAdmin');

        if (!token) {
            alert('Debes iniciar sesi√≥n para ver tus solicitudes.');
            window.location.href = 'inicio.html'; 
            return;
        } else {
            if (cerrarSesionBtn) cerrarSesionBtn.style.display = 'block';
            if (userRole === 'administrador') {
                enlaceAdmin.style.display = 'block';
            } else {
                enlaceUsuarios.style.display = 'block';
            }
            // Prellenar nombre
            document.getElementById('fullName').value = userFullName || "";
        }

        // --- Cargar pedidos actuales del backend ---
        const cartItemsDiv = document.getElementById('cartItems');
        const emptyMessage = document.getElementById('emptyCartMessage');
        const orderDetails = document.getElementById('orderDetails');

        try {
            const res = await fetch(`http://localhost:3000/pedidos/${userId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Error al obtener pedidos");

            const pedidos = await res.json();

            if (pedidos.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                let detalles = "";
                cartItemsDiv.innerHTML = "";
                pedidos.forEach(p => {
                    const item = document.createElement("div");
                    item.classList.add("cart-item");
                    item.innerHTML = `<strong>${p.nombre_uniforme}</strong> - ${p.talla} - Cantidad: ${p.cantidad}`;
                    cartItemsDiv.appendChild(item);
                    detalles += `${p.nombre_uniforme} - ${p.talla} - Cantidad: ${p.cantidad}\n`;
                });
                orderDetails.value = detalles.trim();
            }
        } catch (err) {
            console.error(err);
            alert("No se pudieron cargar tus pedidos.");
        }

        // --- Confirmar pedido ---
        const orderForm = document.getElementById("orderForm");
        orderForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            try {
                const res = await fetch("http://localhost:3000/pedidos", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId,
                        detalles: orderDetails.value
                    })
                });
                if (!res.ok) throw new Error("Error al enviar pedido");
                alert("‚úÖ Tu solicitud fue confirmada con √©xito.");
                window.location.href = "prin.html";
            } catch (err) {
                console.error(err);
                alert("‚ùå No se pudo confirmar la solicitud.");
            }
        });

        // --- Cerrar sesi√≥n ---
        if (cerrarSesionBtn) {
            cerrarSesionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                sessionStorage.clear();
                alert('Has cerrado sesi√≥n exitosamente.');
                window.location.href = 'inicio.html';
            });
        }
    });
  </script>
</body>
</html>